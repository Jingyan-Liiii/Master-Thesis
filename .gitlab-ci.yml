#.init_ssh: &init_ssh |
#  eval $(ssh-agent -s)
#  echo "$PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
#  mkdir -p ~/.ssh
#  chmod 700 ~/.ssh
#  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  
.init_ssh2: &init_ssh2 |
  eval $(ssh-agent -s)
  chmod 700 "$PRIVATE_KEY"
  ls -la "$PRIVATE_KEY"
  ssh-add "$PRIVATE_KEY" > /dev/null
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh
  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

#stages:
#  - build
#  - deploy


build_job:
  image: registry.git.or.rwth-aachen.de/docker/gcg-doc:latest
  stage: build
#  artifacts:
#    paths:
#      - static/build/
#      - webpack-stats.json
#      - .cache/pip
  before_script:
      - *init_ssh2
      - git submodule sync --recursive
      - git submodule update --init --recursive
      - mkdir build
      - cd build
#      - cd lib
#      - ln -s scip-git scip
#      - ln -s bliss-git bliss
#      - cd ..
  script:
      - cmake ..
      - make gcg_doc -j 2
      - cd ..
      # js
      - curl https://scip.zib.de/bootstrap/css/bootstrap.min.css --output doc/html/bootstrap/css/bootstrap.min.css
      - curl https://scip.zib.de/bootstrap/css/custom.css --output doc/html/bootstrap/css/custom.css
      - sed -i 's,https://scip.zib.de/images,../../pictures,g' doc/html/bootstrap/css/custom.css
      - curl https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css --output doc/html/css/font-awesome.min.css
      #- curl https://fonts.googleapis.com/css?family=Open+Sans --output doc/html/css/font-googleapis.css
      #- curl https://fonts.gstatic.com/s/opensans/v17/mem8YaGs126MiZpBA-UFW50bbck.woff2 --output doc/html/css/font-googleapis.woff2
      # css
      - curl https://scip.zib.de/bootstrap/js/custom.js --output doc/html/bootstrap/js/custom.js
      - curl https://scip.zib.de/bootstrap/js/bootstrap.min.js --output doc/html/bootstrap/js/bootstrap.min.js
      - curl https://code.jquery.com/jquery.min.js --output doc/html/js/jquery.min.js
      # upload
      - scp -r doc/html/. gitGCGdoc@orweb.or.rwth-aachen.de:/var/www/gcg-doc-dev
      - ssh gitGCGdoc@orweb.or.rwth-aachen.de "cd /var/www/gcg-doc-dev; chmod -R 755 ./* ; ln -s MathJax/es5/latest.js MathJax/MathJax.js ;"
      #chown -R gitGCGdoc:apache ./*;"
#      - make soplex
#      - cd lib/scip-git
#      - mkdir lib
#      - cd lib
#      - mkdir include
#      - ln -s ../../../soplex-git/src/ include/spxinc
#      - mkdir static
#      - ln -s ../../../soplex-git/lib/libsoplex.linux.x86_64.gnu.opt.a static/libsoplex.linux.x86_64.gnu.opt.a
#      - cd ../../../
#      - make ZIMPL=false
#      - make doc
#  only:
#    - tags
#    - merge_requests


#deploy_production:
#  image: pivotaldata/concourse-ssh
#  stage: deploy
#  dependencies: 
#    - build_job
#  environment:
#    name: Production
#    url: https://orweb.or.rwth-aachen.de
#  only:
#    - tags
#  except:
#    - branches
#  before_script:
#    - *init_ssh
#  script:
#    - echo "Deploying tag $CI_COMMIT_TAG ..."
#    # copy new data to dev
#    - scp -r doc/html gitGCGdoc@orweb.or.rwth-aachen.de:/var/www/gcg-doc-dev
#    - ssh gitGCGdoc@orweb.or.rwth-aachen.de "cd /var/www/gcg-doc-dev; chmod 744 ./* ;"